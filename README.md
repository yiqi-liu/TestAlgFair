# TestAlgFair
The folder `replication-package` inclues the data and code needed for replicating the Monte Carlo simulation and empirical application in Section 8 and Appendix C of [Liu and Molinari (2025)](https://arxiv.org/abs/2402.08879). With proper multithreading configurations, the replication takes about 8 days to finish on a 256-core server with
```
> sessionInfo()
R version 4.4.3 (2025-02-28)
Platform: x86_64-pc-linux-gnu
Running under: Rocky Linux 9.5 (Blue Onyx)

Matrix products: default
BLAS/LAPACK: /usr/lib64/libopenblas-r0.3.26.so;  LAPACK version 3.12.0
```
Before running each `.R` file, make sure the working directory is set to the directory of the current `.R` file.
### Data Structure
- File `all-func.R` includes all functions needed to implement the statistical procedures proposed in the paper. By default, `all-func.R` expects multiple CPUs for parallelization via
  ```
  spec_cpu <- as.integer(Sys.getenv("OMP_NUM_THREADS"))
  torch_set_num_threads(spec_cpu)
  torch_set_num_interop_threads(ceiling(log(spec_cpu)))
  library(doMC)
  registerDoMC(cores=spec_cpu)
  ```
  Comment out this block if `OMP_NUM_THREADS` is not explicitly set.

- Folder `application` includes relevant files for running the empirical application:
    * folder `code` contains code that generates the results in tables and figures. It has two sub-folders, `lasso` and `rf`, each including the following files for the corresponding `[method]`$\in${`"lasso"`, `"rf"`} used for estimating the nuisance parameters:
        - `hypTest-[method].R` for implementing the three hypothesis tests introduced in Section 6. It calls `../results/hypTest-results/hypTest-[method].Rmd` to generate `../results/hypTest-results/hypTest-[method].html` that contains the results in Table II nad Figures 6-7 for `[method]`=`"rf"`, and Figures C.1-C.2 and Table C.1 for `[method]`=`"lasso"`;
        - `buildAlg-[method].R` for building new algorithms on the fairness-accuracy frontier introduced in Section 5.4 that generates Figure 8 in `../../results/buildAlg-results/rf/alt-alg-f1a.png` and Table III in `../../results/buildAlg-results/rf/table_frac_bl_trt.csv` for `[method]`=`"rf"`, and Figure XXX in `../../results/buildAlg-results/lasso/alt-alg-f1a.png` and Table XXX in `../../results/buildAlg-results/lasso/table_frac_bl_trt.csv` for `[method]`=`"lasso"`;
        - `rep-[method].R` for repeating the three hypothesis tests 50 times to assess the Monte Carlo variability of the results.
        It also includes the file `variability.R` that uses results generated by `[method]/rep-[method].R` to produce *NTC*Table*NTC*;
    * folder `results` collect the output from running the files in `code`;
        - folder `hypTest-results` collects the produced `hypTest-[method].html` files from calling `../code/[method]/hypTest-[method].R`;
        - folder `buildAlg-results/[method]` collects `.png` figures and `.csv` files generated from running `../code/[method]/buildAlg-[method].R`;
        - folder `rep-results` collects the produced `variability.html` file from calling `../code/variability.R`;
    * folder `obermeyer-code` contains code adapted from [Obermeyer et al. (2019)](https://gitlab.com/labsysmed/dissecting-bias):
        - folder `dissecting-bias-modified` is a copy of [Obermeyer et al. (2019)](https://gitlab.com/labsysmed/dissecting-bias) that contains 2 additional files in the sub-directory `code/model`, `main_modified.py` and `model_modified.py`, modified based on the orginal files `main.py` and `model.py` in the same sub-directory;
        - folder `plot0` is the source code of `dissecting-bias-modified/plot0_0.1.tar.gz`;
        - file `Obermeyer-Fig1b.R` is adapted from `dissecting-bias-modified/code/figure1/figure1b.R`;
    * folder `data` contains `.csv` data files generated from running `obermeyer-code/dissecting-bias-modified/code/model/main_modified.py`:
        - file `all_Y_x_df.csv` includes the final set of Y and X used for building predictive algorithms;
        - files named `pred_[outcome]_df.csv` are predictions at all observations from the three experimental algorithms discussed in Table 2 of Obermeyer et al. (2019), where `[outcome]`$\in$`{"gagne_sum_t", "log_cost_avoidable", "log_cost"}` corresponding to, respectively, the number of active chronic conditions, avoidable costs, and total costs.

- Folder `simulation` includes the following R scripts for running the simulations:
    * file `simulation-DGPplot.Rmd` generates Figure 5, and files `truth_balance.csv` and `truth_rskew.csv` for use in the other simulation scripts;
    * files named `test[number]n[size]k[kink-status].R` generate results reported in Table 1 for `[kink-status]` being either an empty string (for the case of no kink) or "kink" (for the case where kink is present), `[number]`$\in \{1, 2, 3\}$, where
        - $1$ stands for the weak group skew test;
        - $2$ stands for the LDA test;
        - $3$ stands for the distance-to-$F$ test;
        and `[size]`$\in \{1, 5, 10, 50\}$ denoting the sample size in thousands.


## Replication



We note that results based on random forests trained using the [`grf`](https://grf-labs.github.io/grf/index.html) package is not guaranteed to be reproducible across platforms, even if the same `R` seed is used; see the discussion [here](https://grf-labs.github.io/grf/REFERENCE.html#forests-predict-different-values-depending-on-the-platform-even-though-the-seed-is-the-same). 
Tests involving optimization via stochastic gradient descent, implemented by the [`torch`](https://torch.mlverse.org/) package is also not reproducible even after setting the same seed; see the discussion [here](https://github.com/mlverse/torch/issues/1311). This will affect the reproducibility of the $F$ estimate---and consequently the distance-to-F test in both the simulation study and the empirical application. 

For these reasons, we assess and report the variability of the empirical results by replicating the tests 50 times in *NTC*Table*NTC*. For the simulation study, we expect cross-platform variability to be small, as the simulation results are already averaged across 1000 replications.
